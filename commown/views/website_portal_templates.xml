<?xml version="1.0" encoding="utf-8"?>
<odoo>

  <!-- Add information about missing documents on user details -->
  <template id="portal_layout" inherit_id="portal.portal_layout">
    <xpath expr="//a[@href='/my/account']/ancestor::div[1]/div[1]" position="after">
      <div class="mt-2">
        <t t-set="no_card" t-value="(not user_id.partner_id.id_card1 and not user_id.partner_id.id_card2)" />
        <t t-set="no_poa" t-value="not user_id.partner_id.proof_of_address" />
        <i class="fa fa-copy fa-fw"/><span class="ml-2">ID card</span> <i
            t-attf-class="fa #{no_card and 'fa-exclamation-triangle' or 'fa-check' }"
            t-attf-style="#{no_card and 'color:red' or ''}" />
        <br/>
        <i class="fa fa-copy fa-fw"/><span class="ml-2">Proof of address</span> <i
            t-attf-class="fa #{no_poa and 'fa-exclamation-triangle' or 'fa-check' }"
            t-attf-style="#{no_poa and 'color:red' or ''}"
            />
      </div>
    </xpath>

    <xpath expr="//a[@href='/my/account']/ancestor::div[1]" position="after">
      <t t-set="user_channels" t-value="[c for c in user_id.partner_id.channel_ids if c.channel_type=='channel']"/>
      <div class="mt-4" t-if="user_channels">
        <h4>Contact us</h4>
        <hr class="mt-1 mb-0"/>
          <div class="list-group">
          <t t-set="action_id" t-value="env.ref('mail.action_discuss').id"/>
          <t t-foreach="user_channels" t-as="channel" t-attr-href="">
            <a class="list-group-item" t-attf-href="/web#action=#{action_id}&amp;active_id=#{channel.id}">
              Channel <t t-esc="channel.name"/>
            </a>
          </t>
        </div>
      </div>
    </xpath>

  </template>

  <template id="portal_my_details" inherit_id="portal.portal_my_details">

    <!-- Replace name by firstname + lastname -->
    <xpath expr="//form" position="attributes">
      <attribute name="enctype">multipart/form-data</attribute>
    </xpath>

    <!-- Replace name by firstname + lastname -->
    <xpath expr="//form//input[@name='name']/ancestor::div[1]" position="replace">
      <div t-attf-class="form-group #{error.get('firstname') and 'o_has_error' or ''} col-xl-6">
        <label class="col-form-label" for="firstname">First name</label>
        <input type="text"
               name="firstname"
               t-attf-class="form-control #{error.get('firstname') and 'is-invalid' or ''}"
               t-att-value="firstname or partner.firstname" />
      </div>
      <div t-attf-class="form-group #{error.get('lastname') and 'o_has_error' or ''} col-xl-6">
        <label class="col-form-label" for="lastname">Last name</label>
        <input type="text"
               name="lastname"
               t-attf-class="form-control #{error.get('lastname') and 'is-invalid' or ''}"
               t-att-value="lastname or partner.lastname" />
      </div>
    </xpath>

    <!-- Remove company name -->
    <xpath expr="//form//input[@name='company_name']/ancestor::div[1]" position="replace">
    </xpath>

    <!-- Remove VAT -->
    <xpath expr="//form//input[@name='vat']/ancestor::div[1]" position="replace">
    </xpath>

    <!-- Add ID card and proof of address before address -->
    <xpath expr="//form//select[@name='country_id']/ancestor::div[1]" position="after">

      <h3 class="col-lg-12">Documents</h3>

      <t t-foreach="['id_card1', 'id_card2', 'proof_of_address']" t-as="field">
        <t t-set="label" t-value="partner._fields[field].get_description(env)['string']" />
        <div t-attf-class="form-group #{error.get(field) and 'has-error' or ''} col-lg-6">
          <label class="control-label" t-attf-for="#{field}" t-esc="label" />
          <t t-if="partner[field]">
            <button class="cwn_bin_field_btn pull-right btn btn-sm btn-warning fa fa-trash"
                    title="Trash document"
                    t-attf-data-title-next-click="Undo"
                    t-attf-style="#{absent and 'display:none'}" />
            <button class="cwn_bin_field_btn pull-right btn btn-sm btn-warning fa fa-undo"
                    title="Undo removal"
                    style="display:none" />
          </t>
           <a t-if="partner[field]" download="" class="btn btn-sm btn-info pull-right"
              t-attf-href="/web/image?model=res.partner&amp;download=true&amp;field=#{field}&amp;id=#{partner.id}">
             <i title="Download document" class="fa fa-download" />
          </a>
          <input t-if="not partner[field]" type="file" t-attf-name="#{field}" />
          <input t-else="" type="file" t-attf-name="#{field}" disabled="disabled"/>
        </div>
      </t>

      <script type="text/javascript">
        $(function() {
          $('button.cwn_bin_field_btn').click(function(ev) {
            ev.preventDefault();
            var $div = $(this).closest('div');
            $div.find('button.cwn_bin_field_btn').toggle();
            $div.find('a[download]').toggle();
            var $input = $div.find('input');
            $input.prop('disabled', !$input.prop('disabled'))
          });
        });
      </script>

    </xpath>
  </template>

</odoo>
