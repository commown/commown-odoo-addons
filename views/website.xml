<?xml version="1.0" encoding="utf-8" ?>
<odoo>

  <!-- Cart page: insert a placeholder for the used coupons and
       an input form to add a new one -->
  <template id="cart" inherit_id="website_sale.cart"
            customize_show="True" active="False" name="Coupon input">

    <xpath expr="//t[@t-call='website_sale.cart_lines']" position="after">
      <div id="coupons-placeholder">
        <strong>Coupons</strong>
      </div>
    </xpath>

    <xpath expr="//div[@id='right_column']" position="inside">
      <h4>Coupon</h4>
      <p>Have a code? Enter it and submit:</p>
      <form id="coupon_input" action="#" method="post" class="mb32">
        <input type="hidden" name="csrf_token"
               t-att-value="request.csrf_token()" />
        <div class="input-group">
          <input name="coupon_code" class="form-control"
                 type="text" placeholder="Your code..." />
          <div class="input-group-btn">
            <button type="submit" disabled="disabled" class="btn btn-default">
              <span class="text-muted" style="margin:0 1em">Submit</span>
              <i style="display:none;position:absolute;top:9px;right:6px"
                 class="fa fa-spinner fa-spin"/>
            </button>
          </div>
        </div>
      </form>
      <script type="text/javascript"
              src="/website_sale_coupon/static/src/js/coupon.js"></script>
    </xpath>

  </template>

  <!-- Insert a placeholder for the coupons in the payment page -->
  <template id="payment" inherit_id="website_sale.payment">
    <xpath expr="//div[@id='payment_method']" position="before">
      <div id="coupons-placeholder">
        <strong>Coupons</strong>
      </div>
      <script type="text/javascript"
              src="/website_sale_coupon/static/src/js/coupon.js"></script>
    </xpath>
  </template>


  <!-- Display the coupons on the order followup page -->
  <template id="orders_followup"
            inherit_id="website_portal_sale.orders_followup">
    <xpath expr="//strong[text()='Contact']/ancestor::div[@class='row'][1]"
           position="after">
      <hr/>
      <t t-set="coupons"
         t-value="env['coupon.coupon'].sudo().used_coupons(order)"/>
      <div t-if="coupons" class="row">
        <div class="col-md-12">
          <p><strong>Coupons</strong></p>
          <dl class="dl-horizontal">
            <t t-foreach="coupons" t-as="coupon">
              <dt><code><t t-esc="coupon.code"/></code></dt>
              <dd t-esc="coupon.campaign_id.description"/>
            </t>
          </dl>
        </div>
      </div>

    </xpath>
  </template>

  <!-- Display the coupons on the order confirmation page -->
  <template id="confirmation"
            inherit_id="website_sale.confirmation">
    <xpath expr="//div[@class='oe_cart']//div[@class='oe_structure']"
           position="after">
      <t t-set="coupons"
         t-value="env['coupon.coupon'].sudo().used_coupons(order)"/>
      <div t-if="coupons">
        <h3><strong>Coupons</strong></h3>
        <dl class="dl-horizontal">
          <t t-foreach="coupons" t-as="coupon">
            <dt><code><t t-esc="coupon.code"/></code></dt>
            <dd t-esc="coupon.campaign_id.description"/>
          </t>
        </dl>
      </div>
    </xpath>
  </template>

</odoo>
