<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <!-- Replace image URL in the kanban view -->
    <record model="ir.ui.view" id="view_rating_rating_kanban">
      <field name="name">rating_project_issue_nps.rating.kanban</field>
      <field name="model">rating.rating</field>
      <field name="inherit_id" ref="rating.view_rating_rating_kanban"/>
      <field name="arch" type="xml">
        <xpath expr="//img" position="attributes">
          <attribute name="t-attf-src">/rating_project_issue_nps/static/src/img/rate_with_icon_#{record.rating.raw_value}.png</attribute>
        </xpath>
      </field>
    </record>

    <!-- Replace existing filters by "Promoters", "Passives", "Detractors" -->
    <record model="ir.ui.view" id="view_rating_rating_search">
      <field name="name">rating_project_issue_nps.rating.search</field>
      <field name="model">rating.rating</field>
      <field name="inherit_id" ref="rating.view_rating_rating_search"/>
      <field name="arch" type="xml">
        <xpath expr='(//search//filter)[1]' position="replace">
        </xpath>
        <xpath expr='(//search//filter)[2]' position="replace">
        </xpath>
        <xpath expr='//search//filter' position="replace">
          <filter string="Promoters" domain="[('rating', 'in', (9, 10))]"/>
          <filter string="Passives" domain="[('rating', 'in', (8, 7))]"/>
          <filter string="Detractors" domain="[('rating', '&lt;=', 6)]"/>
        </xpath>
      </field>
    </record>

    <!-- Replace happy ratings display on project dashboard by NPS -->
    <record id="view_project_project_rating_kanban" model="ir.ui.view">
        <field name="name">rating_project_issue_nps.project_kanban</field>
        <field name="model">project.project</field>
        <field name="inherit_id" ref="rating_project.view_project_project_rating_kanban"/>
        <field name="arch" type="xml">
          <field name="use_tasks" position="after">
            <field name="net_promoter_score" invisible="1"/>
          </field>
          <xpath expr="//div[contains(@class, 'o_kanban_primary_left')]//i[contains(@class, 'fa-smile')]/ancestor::div[1]"
                 position="replace">
            <div t-if="record.rating_status.raw_value != 'no'" class="mt8 text-primary"
                 title="Net promoter score over the past 30 days. Get rating details from the More menu.">
              <b>
                <span t-if="record.net_promoter_score == False" class="rating-no-nps">No NPS</span>
                <span class="rating-nps" t-else="">
                  <t t-set="nps_names" t-value="['detractor', 'passive', 'promoter']"/>
                  <t t-set="nps_index" t-value="1 + Math.sign(record.net_promoter_score.raw_value)"/>
                  <t t-debug=""/>
                  <img t-attf-src="rating_project_issue_nps/static/src/img/{{ nps_names[nps_index] }}.png" style="width: 32px;"/>
                  <t t-esc="record.net_promoter_score.raw_value"/>
                  <t t-esc="nps_name"/>
                </span>
              </b>
            </div>
          </xpath>
        </field>
    </record>

  </data>
</odoo>
