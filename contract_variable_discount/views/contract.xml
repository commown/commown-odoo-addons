<odoo>

  <record id="account_analytic_account_recurring_form_form" model="ir.ui.view">
    <field name="name">Contract form</field>
    <field name="model">account.analytic.account</field>
    <field name="inherit_id" ref="contract.account_analytic_account_recurring_form_form"/>
    <field name="arch" type="xml">
      <!-- Remove editable on tree: a big form is needed to edit discount formula -->
      <xpath expr="//field[@name='recurring_invoice_line_ids']/tree"
             position="attributes">
        <attribute name="editable"></attribute>
      </xpath>

      <xpath expr="//field[@name='recurring_invoice_line_ids']"
             position="attributes">
        <attribute name="context">{"analytic_account_id": active_id}</attribute>
      </xpath>

      <!-- Insert `variable_discount` before `discount` -->
      <xpath expr="//field[@name='recurring_invoice_line_ids']/tree/field[@name='discount']"
             position="before">
        <field name="specific_discount_line_ids" invisible="1"/>
        <field name="contract_template_line_id" invisible="1"/>
        <field name="variable_discount"/>
      </xpath>

      <!-- Do not show discount if `variable_discount` is True -->
      <xpath expr="//field[@name='recurring_invoice_line_ids']/tree/field[@name='discount']"
             position="attributes">
        <attribute name="attrs">{'invisible': [('variable_discount', '=', True)]}</attribute>
      </xpath>

    </field>
  </record>

  <!-- Create a contract line form view the tree view can no more be editable -->
  <record id="account_analytic_invoice_line_view_form" model="ir.ui.view">
    <field name="name">Account Analytic Invoice Line Form View</field>
    <field name="model">account.analytic.invoice.line</field>
    <field name="arch" type="xml">
      <form string="Contract Line">
        <group>
          <group name="Article">
            <field name="product_id"/>
            <field name="name"/>
            <field name="analytic_tag_ids" widget="many2many_tags"/>
            <field name="variable_discount" invisible="1"/>
            <field name="contract_template_line_id"/>
          </group>
          <group name="Price">
            <field name="uom_id"/>
            <field name="automatic_price"/>
            <field name="specific_price" attrs="{'invisible': [('automatic_price', '=', True)]}"/>
            <field name="price_unit" attrs="{'invisible': [('automatic_price', '=', False)]}"/>
            <field name="quantity"/>
            <field name="price_subtotal"/>
          </group>
        </group>
        <group name="Discount">
          <field name="inherited_discount_line_ids"/>
          <field name="specific_discount_line_ids"/>
        </group>
      </form>
    </field>
  </record>

</odoo>
